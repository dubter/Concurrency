# Автоматическое тестирование (CI)

## Важно

Пожалуйста, не отлаживайтесь через CI, не отправляйте решения, которые не проходят тесты локально:

В CI через `clippy test` запускаются те же самые тесты!

## Шаги, которые нужно выполнить 1 раз

### Регистрация

#### Шаг 1

Заведите аккаунт на https://gitlab.com/, если у вас его нет.

Не используйте в логине дефис.

#### Шаг 2

Зарегистрируйтесь в приложении [Manytask](http://84.252.128.234:5222/).

##### Форма регистрации

| Поле | Значение |
| - | - |
| _Gitlab Username_ | ваш логин на https://gitlab.com, например, `Lipovsky`. Логин – _case-sensitive_! |
| _First Name_ | ваше имя латиницей (например, `Roman`) |
| _Last Name_ | ваша фамилия латиницей (например, `Lipovsky`) |
| _Group_ | см. телеграм-канал курса |
| _Secret Code_ | его вы узнаете из телеграм-канала курса |

После заполнения формы жмите `Register`. Ждите.

#### Шаг 3

Вы попали в приложение, осмотритесь.

В верхней панели вы увидите ссылки на:
- Созданный для вас приватный репозиторий для решений
- Страницу сабмитов

#### Troubleshooting

В любой непонятной ситуации с приложением поможет одно из двух:
* `/signup` -> Заполняете поля формы -> Жмете `Register`
* `/` -> Жмете `Login`

### Аттач репозитория с решениями

Во время регистрации был создан репозиторий для ваших решений. 

В этот репозиторий вы будете коммитить и пушить решения (только не голыми руками, а через консольный клиент), там же будут запускаться автоматические тесты.

#### Шаг 1

Перейдите в локальную копию репозитория курса:
```shell
cd /workspace/concurrency-course
```

#### Шаг 2

Прицепите к репозиторию курса репозиторий с решениями:
```shell
clippy attach {solutions-repo-url}
```
В `{solutions-repo-url}` подставьте урл созданного при регистрации репозитория.

Команда будет выглядеть примерно так:
```shell
clippy attach https://gitlab.com/concurrency-course-2020/test-roman-lipovsky-u-lipovsky
```

Команду `attach` можно выполнить повторно: предыдущая локальная копия сотрется (с вашего явного разрешения), но это не страшно, если вы запушили все ваши коммиты с помощью `clippy push`.

##### SSH

Можно аттачить репозиторий иначе: 
```shell
clippy attach git@gitlab.com:concurrency-course-2020/test-roman-lipovsky-u-lipovsky
```
Для этого нужно настроить SSH в контейнере, зато потом можно будет не вводить логин и пароль для каждого пуша.

<details>
<summary>Подробнее тут (можно вернуться к этому позже)</summary>

Инструкцию для генерации ключей и привязки их к профилю gitlab можно 
найти [здесь](https://docs.gitlab.com/ee/ssh/).

Для работы в контейнере переименуйте приватный ключ в `gitlab-private-key` 
и положите его в директорию [`docker/config/keys`](/docker/config/keys),
чтобы не потерять при пересборке контейнера.

**Перелогиньтесь в контейнер** и проверьте, что всё работает:
```shell
$ ssh -T git@gitlab.com
Warning: Permanently added 'gitlab.com,172.65.251.78' (ECDSA) to the list of known hosts.
Welcome to GitLab, @Lipovsky!
```

</details>

#### Шаг 3

Выполните команду
```shell
clippy show-config
```

Вы увидите поля конфига, который нужно заполнить для сабмита задач.
Часть полей будет заполнена автоматически (например, `gitlab.user`, `name.first`, `name.last`). Но все же убедитесь, что они заполнены корректно.

#### Шаг 4

Получите токен для работы с API https://gitlab.com/

Для этого на https://gitlab.com/ зайдите в `Settings` своего профиля, затем в `Access Tokens`, выберите произвольное имя для вашего токена, поставьте галку напротив `api` и нажмите `Create personal access token`. 

См. [Personal Access Tokens](https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html)

Токен – это полученная случайная строчка из цифр и букв. Имя токена дальше нам не понадобится.
Сохраните полученный токен, иначе он пропадет! 

Токен будет нужен утилите `clippy` для создания merge request-ов.

#### Шаг 5

Установите токен для консольного клиента:
```shell
clippy config gitlab.token {gitlab-token}
```

Здесь `{gitlab-token}` – токен, полученный вами на предыдущем шаге.

#### Шаг 6

Задайте _assignee_ для ваших MR-ов:
```shell
# Подставьте в команду логин своего семинариста на gitlab.com
clippy config assignee Lipovsky
```

#### Шаг 7

Настройте теги для создаваемых MR-ов:

```shell
# Теги перечисляются через запятую, без лишних пробелов
# Вместо 123 подставьте номер вашей академической группы (если она у вас есть)
clippy config tags "concurrency,123"
```

## Работа с задачей / репозиторием решений

#### Шаг 1

Идем в директорию с задачей:
```shell
cd tasks/intro/aplusb
```

#### Шаг 2

Решаем задачу.

#### Шаг 3

Коммитим файлы текущей задачи в отдельную ветку локального репозитория решений:
```shell
clippy commit
```

Можно указать комментарий к коммиту:
```shell
clippy commit -m 'my precious'
```

#### Шаг 4

Пушим коммиты из локальной ветки задачи в ветку вашего приватного remote-репозитория:
```shell
clippy push
```

#### Шаг 5

Создаем [_merge request_](https://docs.gitlab.com/ee/user/project/merge_requests/) ветки с решением в _master_:
```shell
clippy merge-request
```
После ее выполнения вы получите ссылку на созданный MR. На созданном MR будет запускаться CI.

Команду `merge-request` нужно выполнить всего лишь один раз для каждой задачи.

#### Дальнейшие шаги

Пусть дальше вы нашли и исправили баги в своем коде:

```(bash)
...
clippy commit -m 'fix bug'
...
clippy commit -m 'yet another fix'
clippy push
```

После `push` новые коммиты попадут в уже существующий MR и перезапустят CI.

## Посылки

Вы можете посмотреть все свои посылки во вкладке `Submits` в приложении или в разделе `Merge requests` вашего репозитория с решениями на гитлабе.

Нажав на плашку в колонке `status` вы сможете посмотреть подробный отчет о тестировании.

## Как все устроено

[Картинка](https://gitlab.com/Lipovsky/clippy/-/raw/master/docs/diagram.png)

После регистрации + логина в приложении для вас заводится приватный репозиторий в группе курса на gitlab. В этот репозиторий с помощью консольного клиента вы будете коммитить / пушить решения задач, на этом же репозитории будут запускаться тесты.

Команда `clippy attach` клонирует этот приватный репозиторий локально в соседнюю с репозиторием курса директорию. 

Для каждой задачи в этом репозитории будет создаваться отдельная ветка (например, `intro/aplusb`).

Команда `clippy commit` коммитит файлы текущей задачи (см. `submit_files` в `task.json`) _локально_ в ваш репозиторий решений.

Команда `clippy push` пушит коммиты из ветки текущей задачи локального репозитория решений в remote-репозиторий.

Команда `clippy merge-request` создает для текущей задачи [merge request](https://docs.gitlab.com/ee/user/project/merge_requests/) из ветки решения в мастер со всеми запушенными коммитами.

[Документация по командам](https://gitlab.com/Lipovsky/clippy/-/blob/master/docs/commands.md)

В ветку с решением автоматически добавляется файл [gitlab-ci.yml](.grade.gitlab-ci.yml) – это конфиг для запуска тестов (чуть точнее, _джобов_ CI).

Запуск джоба CI на тестирующем сервере состоит из следующих шагов:

1) Скачивается ветка с файлами задачи из вашего репозитория решений.
2) Эти файлы накатываются на директорию задачи в репозитории курса.
3) На задаче в репозитории курса запускаются `clippy validate`, `clippy test`, т.е. ровно те же команды, что вы запускаете локально.
